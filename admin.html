<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Wrestling Hub</title>
</head>
<body style="font-family:system-ui; padding:16px; max-width:720px;">
  <h1>Admin</h1>
  <p>Team slug (example: <code>ravens-wrestling</code>)</p>

  <label>Team Slug<br>
    <input id="slug" style="width:100%; padding:10px;" value="ravens-wrestling">
  </label><br><br>

  <label>Admin Token<br>
    <input id="token" type="password" style="width:100%; padding:10px;" placeholder="paste ADMIN_TOKEN">
  </label>

  <hr style="margin:22px 0;">

  <h2 id="athleteFormTitle">Add Athlete</h2>
  <input id="a_id" type="hidden">
  <label>Name<br><input id="a_name" style="width:100%; padding:10px;"></label><br><br>

  <label>Weight Class (ex: 138, 145, 152)<br>
    <input id="a_weight" style="width:100%; padding:10px;">
  </label><br><br>

  <label>Wins<br><input id="a_wins" type="number" style="width:100%; padding:10px;" value="0"></label><br><br>
  <label>Losses<br><input id="a_losses" type="number" style="width:100%; padding:10px;" value="0"></label><br><br>
  <button id="saveAthlete" style="padding:10px 14px;">Save Athlete</button>
  <button id="cancelAthlete" style="padding:10px 14px; display:none;">Cancel</button>

  <hr style="margin:22px 0;">

  <h2 id="videoFormTitle">Add Video</h2>
  <input id="v_id" type="hidden">
  <label>Title<br><input id="v_title" style="width:100%; padding:10px;"></label><br><br>

  <label>Wrestler (optional)<br>
    <select id="v_athlete" style="width:100%; padding:10px;">
      <option value="">Team / All</option>
    </select>
  </label><br><br>

  <label>YouTube URL or ID<br><input id="v_youtube" style="width:100%; padding:10px;"></label><br><br>
  <button id="saveVideo" style="padding:10px 14px;">Save Video</button>
  <button id="cancelVideo" style="padding:10px 14px; display:none;">Cancel</button>

  <hr style="margin:22px 0;">

  <h2 id="scheduleFormTitle">Add Schedule Event</h2>
  <input id="s_id" type="hidden">
  <label>Date (YYYY-MM-DD)<br>
    <input id="s_date" style="width:100%; padding:10px;" placeholder="2026-01-05">
  </label><br><br>

  <label>Title<br>
    <input id="s_title" style="width:100%; padding:10px;" placeholder="Dual vs Lane Tech">
  </label><br><br>

  <label>Opponent (optional)<br>
    <input id="s_opp" style="width:100%; padding:10px;" placeholder="Lane Tech">
  </label><br><br>

  <label>Location (optional)<br>
    <input id="s_loc" style="width:100%; padding:10px;" placeholder="Intrinsic Downtown Gym">
  </label><br><br>

  <label>Notes (optional)<br>
    <input id="s_notes" style="width:100%; padding:10px;" placeholder="Weigh-ins 4:30pm">
  </label><br><br>

  <button id="saveSchedule" style="padding:10px 14px;">Save Schedule Event</button>
  <button id="cancelSchedule" style="padding:10px 14px; display:none;">Cancel</button>

  <hr style="margin:22px 0;">

  <h2>Manage</h2>
  <button id="refresh" style="padding:10px 14px;">Refresh Lists</button>

  <h3 style="margin-top:14px;">Athletes</h3>
  <div id="listAthletes"></div>

  <h3 style="margin-top:14px;">Videos</h3>
  <div id="listVideos"></div>

  <h3 style="margin-top:14px;">Schedule</h3>
  <div id="listSchedule"></div>

  <pre id="out" style="margin-top:18px; background:#f5f5f5; padding:12px; overflow:auto;"></pre>

<script>
const out = (msg) => document.getElementById('out').textContent = msg;

function slugVal(){ return document.getElementById('slug').value.trim(); }

async function post(path, payload) {
  const token = document.getElementById('token').value.trim();
  const res = await fetch(path, {
    method: 'POST',
    headers: { 'content-type': 'application/json', 'x-admin-token': token },
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  if (!res.ok) throw new Error(res.status + " " + text);
  return text;
}

async function getJson(path) {
  const res = await fetch(path);
  const text = await res.text();
  if (!res.ok) throw new Error(res.status + " " + text);
  return JSON.parse(text);
}

// Athlete form reset
function resetAthleteForm() {
  document.getElementById('a_id').value = '';
  document.getElementById('a_name').value = '';
  document.getElementById('a_weight').value = '';
  document.getElementById('a_wins').value = '0';
  document.getElementById('a_losses').value = '0';
  document.getElementById('athleteFormTitle').textContent = 'Add Athlete';
  document.getElementById('cancelAthlete').style.display = 'none';
}

// Video form reset
function resetVideoForm() {
  document.getElementById('v_id').value = '';
  document.getElementById('v_title').value = '';
  document.getElementById('v_youtube').value = '';
  document.getElementById('v_athlete').value = '';
  document.getElementById('videoFormTitle').textContent = 'Add Video';
  document.getElementById('cancelVideo').style.display = 'none';
}

// Schedule form reset
function resetScheduleForm() {
  document.getElementById('s_id').value = '';
  document.getElementById('s_date').value = '';
  document.getElementById('s_title').value = '';
  document.getElementById('s_opp').value = '';
  document.getElementById('s_loc').value = '';
  document.getElementById('s_notes').value = '';
  document.getElementById('scheduleFormTitle').textContent = 'Add Schedule Event';
  document.getElementById('cancelSchedule').style.display = 'none';
}

// Save athlete (add or update)
document.getElementById('saveAthlete').onclick = async () => {
  try {
    const slug = slugVal();
    const id = document.getElementById('a_id').value;
    const payload = {
      name: document.getElementById('a_name').value,
      weight_class: document.getElementById('a_weight').value,
      wins: document.getElementById('a_wins').value,
      losses: document.getElementById('a_losses').value
    };
    
    if (id) {
      payload.id = id;
      await post(`/api/team/${encodeURIComponent(slug)}/athlete-update`, payload);
      out("Athlete updated ✅");
    } else {
      await post(`/api/team/${encodeURIComponent(slug)}/athlete`, payload);
      out("Athlete saved ✅");
    }
    
    resetAthleteForm();
    await refreshLists();
  } catch (e) { out("Error ❌\n" + e); }
};

document.getElementById('cancelAthlete').onclick = () => {
  resetAthleteForm();
  out("Cancelled");
};

// Save video (add or update)
document.getElementById('saveVideo').onclick = async () => {
  try {
    const slug = slugVal();
    const id = document.getElementById('v_id').value;
    const athleteVal = document.getElementById('v_athlete').value;

    const payload = {
      title: document.getElementById('v_title').value,
      youtube: document.getElementById('v_youtube').value,
      athlete_id: athleteVal ? Number(athleteVal) : null
    };

    if (id) {
      payload.id = id;
      await post(`/api/team/${encodeURIComponent(slug)}/video-update`, payload);
      out("Video updated ✅");
    } else {
      await post(`/api/team/${encodeURIComponent(slug)}/video`, payload);
      out("Video saved ✅");
    }
    
    resetVideoForm();
    await refreshLists();
  } catch (e) { out("Error ❌\n" + e); }
};

document.getElementById('cancelVideo').onclick = () => {
  resetVideoForm();
  out("Cancelled");
};

// Save schedule (add or update)
document.getElementById('saveSchedule').onclick = async () => {
  try {
    const slug = slugVal();
    const id = document.getElementById('s_id').value;
    const payload = {
      event_date: document.getElementById('s_date').value,
      title: document.getElementById('s_title').value,
      opponent: document.getElementById('s_opp').value,
      location: document.getElementById('s_loc').value,
      notes: document.getElementById('s_notes').value
    };
    
    if (id) {
      payload.id = id;
      await post(`/api/team/${encodeURIComponent(slug)}/schedule-update`, payload);
      out("Schedule updated ✅");
    } else {
      await post(`/api/team/${encodeURIComponent(slug)}/schedule`, payload);
      out("Schedule saved ✅");
    }
    
    resetScheduleForm();
    await refreshLists();
  } catch (e) { out("Error ❌\n" + e); }
};

document.getElementById('cancelSchedule').onclick = () => {
  resetScheduleForm();
  out("Cancelled");
};

// Manage / Delete / Edit
async function refreshLists() {
  const slug = slugVal();

  const a = await getJson(`/api/team/${encodeURIComponent(slug)}/athletes`);
  const teamData = await getJson(`/api/team/${encodeURIComponent(slug)}`);
  const v = { videos: teamData.videos };
  const s = await getJson(`/api/team/${encodeURIComponent(slug)}/schedule-list`);

  // fill wrestler dropdown for videos
  const sel = document.getElementById('v_athlete');
  if (sel) {
    sel.innerHTML =
      '<option value="">Team / All</option>' +
      (a.athletes || []).map(x =>
        `<option value="${x.id}">${x.name}${x.weight_class ? ' ('+x.weight_class+')' : ''}</option>`
      ).join('');
  }

  document.getElementById('listAthletes').innerHTML =
    (a.athletes || []).map(x => `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
        <div><b>${x.name}</b> ${x.weight_class ? `(${x.weight_class})` : ''} — ${x.wins}-${x.losses}</div>
        <div style="display:flex;gap:6px;">
          <button data-id="${x.id}" class="editAthlete" style="padding:6px 10px;">Edit</button>
          <button data-id="${x.id}" class="delAthlete" style="padding:6px 10px;">Delete</button>
        </div>
      </div>
    `).join('') || '<div style="color:#666;">No athletes</div>';

  document.getElementById('listVideos').innerHTML =
    (v.videos || []).map(x => `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
        <div><b>${x.title}</b> — ${x.youtube_id}${x.athlete_name ? ` <span style="color:#666;">( ${x.athlete_name} )</span>` : ''}</div>
        <div style="display:flex;gap:6px;">
          <button data-id="${x.id}" class="editVideo" style="padding:6px 10px;">Edit</button>
          <button data-id="${x.id}" class="delVideo" style="padding:6px 10px;">Delete</button>
        </div>
      </div>
    `).join('') || '<div style="color:#666;">No videos</div>';

  document.getElementById('listSchedule').innerHTML =
    (s.schedule || []).map(x => `
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
        <div><b>${x.event_date}</b> — ${x.title}</div>
        <div style="display:flex;gap:6px;">
          <button data-id="${x.id}" class="editSchedule" style="padding:6px 10px;">Edit</button>
          <button data-id="${x.id}" class="delSchedule" style="padding:6px 10px;">Delete</button>
        </div>
      </div>
    `).join('') || '<div style="color:#666;">No schedule events</div>';

  // Wire edit athlete buttons
  document.querySelectorAll('.editAthlete').forEach(btn => btn.onclick = async () => {
    const athlete = a.athletes.find(x => x.id == btn.dataset.id);
    if (!athlete) return;
    
    document.getElementById('a_id').value = athlete.id;
    document.getElementById('a_name').value = athlete.name;
    document.getElementById('a_weight').value = athlete.weight_class || '';
    document.getElementById('a_wins').value = athlete.wins;
    document.getElementById('a_losses').value = athlete.losses;
    document.getElementById('athleteFormTitle').textContent = 'Edit Athlete';
    document.getElementById('cancelAthlete').style.display = 'inline-block';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Wire edit video buttons
  document.querySelectorAll('.editVideo').forEach(btn => btn.onclick = async () => {
    const video = v.videos.find(x => x.id == btn.dataset.id);
    if (!video) return;
    
    document.getElementById('v_id').value = video.id;
    document.getElementById('v_title').value = video.title;
    document.getElementById('v_youtube').value = video.youtube_id;
    document.getElementById('v_athlete').value = video.athlete_id || '';
    document.getElementById('videoFormTitle').textContent = 'Edit Video';
    document.getElementById('cancelVideo').style.display = 'inline-block';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Wire edit schedule buttons
  document.querySelectorAll('.editSchedule').forEach(btn => btn.onclick = async () => {
    const event = s.schedule.find(x => x.id == btn.dataset.id);
    if (!event) return;
    
    document.getElementById('s_id').value = event.id;
    document.getElementById('s_date').value = event.event_date;
    document.getElementById('s_title').value = event.title;
    document.getElementById('s_opp').value = event.opponent || '';
    document.getElementById('s_loc').value = event.location || '';
    document.getElementById('s_notes').value = event.notes || '';
    document.getElementById('scheduleFormTitle').textContent = 'Edit Schedule Event';
    document.getElementById('cancelSchedule').style.display = 'inline-block';
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Wire delete buttons
  document.querySelectorAll('.delAthlete').forEach(btn => btn.onclick = async () => {
    if (!confirm("Delete this athlete?")) return;
    try {
      await post(`/api/team/${encodeURIComponent(slug)}/athlete-delete`, { id: btn.dataset.id });
      out("Deleted athlete ✅");
      await refreshLists();
    } catch (e) { out("Error ❌\n" + e); }
  });

  document.querySelectorAll('.delVideo').forEach(btn => btn.onclick = async () => {
    if (!confirm("Delete this video?")) return;
    try {
      await post(`/api/team/${encodeURIComponent(slug)}/video-delete`, { id: btn.dataset.id });
      out("Deleted video ✅");
      await refreshLists();
    } catch (e) { out("Error ❌\n" + e); }
  });

  document.querySelectorAll('.delSchedule').forEach(btn => btn.onclick = async () => {
    if (!confirm("Delete this schedule event?")) return;
    try {
      await post(`/api/team/${encodeURIComponent(slug)}/schedule-delete`, { id: btn.dataset.id });
      out("Deleted schedule event ✅");
      await refreshLists();
    } catch (e) { out("Error ❌\n" + e); }
  });
}

document.getElementById('refresh').onclick = async () => {
  try {
    await refreshLists();
    out("Lists refreshed ✅");
  } catch (e) { out("Error ❌\n" + e); }
};

// auto-load lists
setTimeout(() => { refreshLists().catch(()=>{}); }, 200);
</script>
</body>
</html>
